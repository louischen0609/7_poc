# ğŸ—ï¸ AI å®¢æœç³»çµ± - å®Œæ•´æ¶æ§‹æ–‡ä»¶

## ç³»çµ±æ¦‚è¿°

é€™æ˜¯ä¸€å€‹åŸºæ–¼ **AI Agent** çš„æ™ºèƒ½å®¢æœç³»çµ±ï¼Œä½¿ç”¨ **LangGraph StateGraph** å¯¦ä½œç‹€æ…‹æ©Ÿé©…å‹•çš„ä¸‹å–®æµç¨‹ï¼Œæ­é… **ReAct Agent** è™•ç†ä¸€èˆ¬æŸ¥è©¢ã€‚é€éå·¥å…·å‡½æ•¸èˆ‡ SQLite è³‡æ–™åº«äº’å‹•ï¼Œå¯¦ç¾ç”¢å“æŸ¥è©¢ã€è¨‚å–®ç®¡ç†ã€åº«å­˜è¿½è¹¤ç­‰å®Œæ•´åŠŸèƒ½ã€‚

---

## ğŸ“ ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±¤ (Frontend)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“± å®¢æˆ¶èŠå¤©ä»‹é¢      ğŸ“Š ç®¡ç†å¾Œå°          ğŸ›’ ç”¢å“åˆ—è¡¨           â”‚
â”‚  (index.html)        (admin.html)        (products.html)        â”‚
â”‚  â€¢ èŠå¤©è¨Šæ¯è¼¸å…¥      â€¢ æŸ¥çœ‹è³‡æ–™è¡¨         â€¢ ç”¢å“åç¨±/åƒ¹æ ¼        â”‚
â”‚  â€¢ å°è©±æ­·å²é¡¯ç¤º      â€¢ æŸ¥çœ‹è¨‚å–®æ˜ç´°       â€¢ åº«å­˜/ä¾›æ‡‰å•†          â”‚
â”‚  â€¢ Session ç®¡ç†      â€¢ æ•¸æ“šæœå°‹           â€¢ å³æ™‚æ›´æ–°             â”‚
â”‚                                                                  â”‚
â”‚  JavaScript (app.js) + CSS (style.css)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP/REST API
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API å±¤ (FastAPI Backend)                       â”‚
â”‚                          main.py                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ”¹ POST /api/chat          â†’ StateGraph agent è™•ç†å°è©±          â”‚
â”‚  ğŸ”¹ GET  /api/admin/table/* â†’ æŸ¥è©¢è³‡æ–™è¡¨æ•¸æ“š                     â”‚
â”‚  ğŸ”¹ GET  /api/admin/order/* â†’ æŸ¥è©¢è¨‚å–®æ˜ç´°                       â”‚
â”‚  ğŸ”¹ GET  /                  â†’ å®¢æˆ¶èŠå¤©ä»‹é¢                       â”‚
â”‚  ğŸ”¹ GET  /admin             â†’ ç®¡ç†å¾Œå°                           â”‚
â”‚  ğŸ”¹ GET  /products          â†’ ç”¢å“åˆ—è¡¨é é¢                       â”‚
â”‚                                                                  â”‚
â”‚  Session ç®¡ç†ï¼šMemorySaver checkpointer (thread_id)              â”‚
â”‚  ğŸ“¦ models.py (ChatRequest, ChatResponse)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                              â”‚
               â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI Agent å±¤ (LangGraph)    â”‚   â”‚       è³‡æ–™åº«ç®¡ç†å±¤            â”‚
â”‚         agent.py             â”‚   â”‚        database.py            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              â”‚   â”‚                              â”‚
â”‚  ğŸ“Š StateGraph               â”‚   â”‚  â€¢ init_db()     å»ºç«‹è³‡æ–™è¡¨  â”‚
â”‚     (ç‹€æ…‹æ©Ÿé©…å‹•ä¸‹å–®æµç¨‹)       â”‚   â”‚  â€¢ seed_sample_data() å¡«å……   â”‚
â”‚                              â”‚   â”‚  â€¢ get_connection() é€£ç·š     â”‚
â”‚  ğŸ¤– General ReAct Agent      â”‚   â”‚                              â”‚
â”‚     (ä¸€èˆ¬æŸ¥è©¢ç”¨)              â”‚   â”‚  ğŸ“Š SQLite DB               â”‚
â”‚                              â”‚   â”‚     (product.db)             â”‚
â”‚  ğŸ§  LLM: ChatGroq            â”‚   â”‚     5 å¼µè³‡æ–™è¡¨               â”‚
â”‚     llama-3.3-70b-versatile  â”‚   â”‚                              â”‚
â”‚                              â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  ğŸ”„ Structured Output        â”‚               â”‚
â”‚     (Pydantic çµæ§‹åŒ–æå–)     â”‚               â”‚
â”‚                              â”‚               â”‚
â”‚  ğŸ› ï¸ 8 å€‹å·¥å…·å‡½æ•¸:            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     tools.py                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€ ğŸ”§ register_customer   (å»ºç«‹/æ›´æ–°å®¢æˆ¶)
               â”œâ”€ ğŸ”§ create_order_draft  (é©—è­‰å“é …ã€è¨ˆç®—é‡‘é¡)
               â”œâ”€ ğŸ”§ preview_final_order (é è¦½å«é…é€çš„å®Œæ•´è¨‚å–®)
               â”œâ”€ ğŸ”§ confirm_order       (å¯«å…¥è¨‚å–®ã€æ‰£åº«å­˜)
               â”œâ”€ ğŸ”§ query_products      (æŸ¥è©¢ç”¢å“)
               â”œâ”€ ğŸ”§ check_stock         (æª¢æŸ¥åº«å­˜)
               â”œâ”€ ğŸ”§ query_orders        (æŸ¥è©¢è¨‚å–®)
               â””â”€ ğŸ”§ record_wastage      (è¨˜éŒ„æè€—)
                          â”‚
                          â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚       å¤–éƒ¨ API æœå‹™           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚  ğŸŒ Groq API                 â”‚
           â”‚     (LLM æ¨ç†æœå‹™)            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ StateGraph ç‹€æ…‹æ©Ÿæ¶æ§‹

Agent ä½¿ç”¨ LangGraph StateGraph å¯¦ä½œç¢ºå®šæ€§çš„ä¸‹å–®æµç¨‹ã€‚æ¯å€‹æ­¥é©Ÿæ˜¯ä¸€å€‹ phase handlerï¼Œæ­¥é©Ÿè½‰æ›ç”±ç¨‹å¼ç¢¼æ§åˆ¶ï¼ˆé LLM åˆ¤æ–·ï¼‰ï¼Œç¢ºä¿ä¸æœƒè·³æ­¥é©Ÿã€‚

### ç‹€æ…‹å®šç¾© (OrderState)

```python
class OrderState(TypedDict):
    messages: Annotated[list, add_messages]  # å°è©±æ­·å²ï¼ˆç”± MemorySaver è‡ªå‹•æŒä¹…åŒ–ï¼‰
    workflow_phase: str      # ç•¶å‰æµç¨‹éšæ®µ
    customer_name: str       # å®¢æˆ¶åç¨±
    customer_address: str    # å®¢æˆ¶åœ°å€
    customer_phone: str      # å®¢æˆ¶é›»è©±
    customer_id: int         # å®¢æˆ¶ ID
    items: list[dict]        # è¨‚è³¼å“é … [{product_name, quantity}]
    delivery_method: str     # é…é€æ–¹å¼ï¼ˆå°ˆè»Š/éƒµå¯„ï¼‰
    payment_method: str      # æ”¶æ¬¾æ–¹å¼ï¼ˆç¾é‡‘/åŒ¯æ¬¾/è²¨åˆ°ä»˜æ¬¾ï¼‰
```

### æµç¨‹ç‹€æ…‹åœ–

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   idle   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                  â”‚
                             â”‚                                        â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
                â”‚ ç”¨æˆ¶èªªã€Œä¸‹å–®ã€          â”‚ ä¸€èˆ¬æŸ¥è©¢                   â”‚
                â–¼                         â–¼                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
       â”‚  collect_info  â”‚      â”‚  general_agent   â”‚                  â”‚
       â”‚ æ”¶é›†å®¢æˆ¶è³‡æ–™    â”‚      â”‚  (ReAct Agent)   â”‚                  â”‚
       â”‚                â”‚      â”‚  query_products   â”‚                  â”‚
       â”‚ LLMæå–:       â”‚      â”‚  check_stock      â”‚                  â”‚
       â”‚ åç¨±/åœ°å€/é›»è©±  â”‚      â”‚  query_orders     â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  record_wastage   â”‚                  â”‚
               â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
               â–¼                                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
       â”‚  confirm_info  â”‚â—„â”€â”€â”€â”€ ç”¨æˆ¶è¦ä¿®æ”¹ â”€â”€â”                         â”‚
       â”‚ ç¢ºèªå®¢æˆ¶è³‡æ–™    â”‚                    â”‚                        â”‚
       â”‚                â”‚                    â”‚                        â”‚
       â”‚ é¡¯ç¤º:          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
       â”‚ åç¨±/åœ°å€/é›»è©±  â”‚   â”‚                                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                        â”‚
               â”‚ ç”¨æˆ¶ã€Œç¢ºèªã€â”‚                                        â”‚
               â”‚             â”‚                                        â”‚
               â–¼             â”‚                                        â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                                        â”‚
       â”‚ register +     â”‚   â”‚                                        â”‚
       â”‚ show_products  â”‚   â”‚                                        â”‚
       â”‚                â”‚   â”‚                                        â”‚
       â”‚ ğŸ”§ register_customer                                        â”‚
       â”‚ ğŸ”§ query_products                                           â”‚
       â”‚ + ç”¢å“åˆ—è¡¨é€£çµ  â”‚                                            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
               â”‚                                                      â”‚
               â–¼                                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
       â”‚ collect_items  â”‚â—„â”€â”€â”€â”€ é©—è­‰å¤±æ•— â”€â”€â”                           â”‚
       â”‚ é¸æ“‡è¨‚è³¼å“é …    â”‚                  â”‚                          â”‚
       â”‚                â”‚                  â”‚                          â”‚
       â”‚ Regex è§£æ:     â”‚                  â”‚                         â”‚
       â”‚ è˜‹æœ*2 ç‰›å¥¶*3  â”‚                  â”‚                          â”‚
       â”‚ (fallback LLM)â”‚                  â”‚                          â”‚
       â”‚                â”‚                  â”‚                          â”‚
       â”‚ ğŸ”§ create_order_draft             â”‚                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                          â”‚
               â”‚ é©—è­‰é€šé                   â”‚                          â”‚
               â–¼                           â”‚                          â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                          â”‚
       â”‚ confirm_items  â”‚â”€â”€â”€â”€ ç”¨æˆ¶è¦ä¿®æ”¹ â”€â”€â”˜                          â”‚
       â”‚ ç¢ºèªè¨‚å–®è‰ç¨¿    â”‚    (åˆä½µå“é …,                                â”‚
       â”‚                â”‚     é‡æ–°é©—è­‰)                                â”‚
       â”‚ é¡¯ç¤º:          â”‚                                             â”‚
       â”‚ å“é …/æ•¸é‡/é‡‘é¡  â”‚                                             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
               â”‚ ç”¨æˆ¶ã€Œç¢ºèªã€                                          â”‚
               â–¼                                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
       â”‚collect_delivery â”‚â—„â”€â”€â”€â”€ ç”¨æˆ¶è¦ä¿®æ”¹ â”€â”€â”                        â”‚
       â”‚ å•é…é€/æ”¶æ¬¾æ–¹å¼  â”‚                    â”‚                       â”‚
       â”‚                 â”‚                    â”‚                       â”‚
       â”‚ LLMæå–:        â”‚                    â”‚                       â”‚
       â”‚ é…é€/æ”¶æ¬¾æ–¹å¼    â”‚                    â”‚                       â”‚
       â”‚                 â”‚                    â”‚                       â”‚
       â”‚ ğŸ”§ preview_final_order               â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                       â”‚
                â”‚                             â”‚                       â”‚
                â–¼                             â”‚                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚                       â”‚
       â”‚ preview_order  â”‚â”€â”€â”€â”€ ç”¨æˆ¶è¦ä¿®æ”¹ â”€â”€â”€â”€â”€â”˜                       â”‚
       â”‚ æœ€çµ‚è¨‚å–®é è¦½    â”‚                                             â”‚
       â”‚                â”‚                                             â”‚
       â”‚ é¡¯ç¤º:          â”‚                                             â”‚
       â”‚ å“é …+é…é€+æ”¶æ¬¾  â”‚                                             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
               â”‚ ç”¨æˆ¶ã€Œç¢ºèªã€                                          â”‚
               â–¼                                                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
       â”‚ order_complete â”‚                                             â”‚
       â”‚ è¨‚å–®å»ºç«‹å®Œæˆ    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚   workflow_phase â†’ "idle"
       â”‚ ğŸ”§ confirm_order                    items/delivery â†’ æ¸…é™¤
       â”‚ (å¯«å…¥DB+æ‰£åº«å­˜) â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¯å€‹ç¯€é»çš„ Tool æ¬Šé™

| ç¯€é» | å¯ç”¨ Tools | èªªæ˜ |
|------|-----------|------|
| idle (ä¸€èˆ¬æŸ¥è©¢) | query_products, check_stock, query_orders, record_wastage | ReAct Agent è‡ªç”±èª¿ç”¨ |
| collect_info | ç„¡ï¼ˆLLM structured outputï¼‰ | åªåšè³‡æ–™æå– |
| confirm_info â†’ ç¢ºèª | register_customer, query_products | è¨»å†Šå®¢æˆ¶ + åˆ—å‡ºç”¢å“ |
| collect_items | create_order_draft | é©—è­‰å“é …å’Œåº«å­˜ |
| confirm_items â†’ ä¿®æ”¹ | create_order_draft | åˆä½µå“é …å¾Œé‡æ–°é©—è­‰ |
| collect_delivery | preview_final_order | ç”¢ç”Ÿå®Œæ•´é è¦½ |
| preview_order â†’ ç¢ºèª | confirm_order | å¯«å…¥ DB ä¸¦æ‰£åº«å­˜ |

### èˆ‡èˆŠæ¶æ§‹ (ReAct) çš„å·®ç•°

| | èˆŠæ¶æ§‹ (ReAct) | æ–°æ¶æ§‹ (StateGraph) |
|---|---|---|
| **æµç¨‹æ§åˆ¶** | LLM æ ¹æ“š System Prompt åˆ¤æ–· | ç¨‹å¼ç¢¼æ§åˆ¶æ­¥é©Ÿè½‰æ› |
| **è·³æ­¥é©Ÿé¢¨éšª** | LLM å¯èƒ½è·³éç¢ºèªæˆ–ä¿®æ”¹æ­¥é©Ÿ | çµæ§‹ä¸Šä¸å¯èƒ½è·³æ­¥é©Ÿ |
| **Tool æ¬Šé™** | æ‰€æœ‰ 8 å€‹ tool éš¨æ™‚å¯ç”¨ | æ¯å€‹ç¯€é»åªç¶å®šç›¸é—œ tool |
| **ç‹€æ…‹å„²å­˜** | å°è©±æ­·å²ï¼ˆæˆªæ–·å¾Œå¯èƒ½ä¸Ÿå¤±ï¼‰ | TypedDict æ˜ç¢ºå„²å­˜æ‰€æœ‰æ¬„ä½ |
| **Session** | æ‰‹å‹• dict + 20 æ¢æˆªæ–· | MemorySaver checkpointer |
| **å“é …è§£æ** | LLM è‡ªè¡Œç†è§£ | Regex å„ªå…ˆ + LLM fallback |
| **Tool å›å‚³** | åµŒå…¥ LLM æŒ‡ä»¤ï¼ˆã€Œç¦æ­¢çœç•¥ã€ï¼‰ | ç´”è³‡æ–™ï¼Œç„¡æ§åˆ¶æŒ‡ä»¤ |

---

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹ (SQLite)

```
product.db
â”œâ”€ ğŸ‘¤ customer               (å®¢æˆ¶è³‡æ–™è¡¨)
â”‚  â”œâ”€ customer_id (PK)
â”‚  â”œâ”€ customer_name
â”‚  â”œâ”€ customer_address
â”‚  â””â”€ customer_phone
â”‚
â”œâ”€ ğŸ“¦ product                (ç”¢å“è³‡æ–™è¡¨)
â”‚  â”œâ”€ product_id (PK)
â”‚  â”œâ”€ product_name
â”‚  â”œâ”€ unit                   (ç®±/ç“¶/ç›’/åŒ…)
â”‚  â”œâ”€ price
â”‚  â”œâ”€ stock
â”‚  â”œâ”€ safety_stock
â”‚  â”œâ”€ supplier
â”‚  â””â”€ specification
â”‚
â”œâ”€ ğŸ›’ orders                 (è¨‚å–®ä¸»è¡¨)
â”‚  â”œâ”€ order_id (PK)
â”‚  â”œâ”€ customer_name
â”‚  â”œâ”€ delivery_method        (å°ˆè»Š/éƒµå¯„)
â”‚  â”œâ”€ payment_method         (ç¾é‡‘/åŒ¯æ¬¾/è²¨åˆ°ä»˜æ¬¾)
â”‚  â”œâ”€ total_price
â”‚  â””â”€ is_delivered           (0=æœªé…é€, 1=å·²é…é€)
â”‚
â”œâ”€ ğŸ“‹ customer_order_detail  (è¨‚å–®æ˜ç´°è¡¨)
â”‚  â”œâ”€ id (PK)
â”‚  â”œâ”€ customer_id (FK â†’ customer)
â”‚  â”œâ”€ product_id (FK â†’ product)
â”‚  â”œâ”€ order_id (FK â†’ orders)
â”‚  â”œâ”€ quantity
â”‚  â””â”€ unit_price
â”‚
â””â”€ âš ï¸ wastage                (æè€—è¨˜éŒ„è¡¨)
   â”œâ”€ id (PK)
   â”œâ”€ product_name
   â”œâ”€ product_id (FK â†’ product)
   â””â”€ loss_quantity
```

### è³‡æ–™è¡¨é—œä¿‚

- `customer` â†” `customer_order_detail`ï¼šä¸€å°å¤š
- `product` â†” `customer_order_detail`ï¼šä¸€å°å¤š
- `orders` â†” `customer_order_detail`ï¼šä¸€å°å¤š
- `product` â†” `wastage`ï¼šä¸€å°å¤š
- Foreign keys ç”± `PRAGMA foreign_keys = ON` å¼·åˆ¶ç´„æŸ

---

## ğŸ”„ æ ¸å¿ƒæ•¸æ“šæµç¨‹

### 1. å®¢æˆ¶å°è©±æµç¨‹

```
1. å®¢æˆ¶åœ¨å‰ç«¯è¼¸å…¥è¨Šæ¯
   â†“
2. POST /api/chat ç™¼é€è«‹æ±‚ (message + session_id)
   â†“
3. main.py ä»¥ thread_id=session_id å‘¼å« StateGraph
   â†“
4. MemorySaver è¼‰å…¥è©² session çš„å®Œæ•´ OrderState
   â†“
5. process_message æ ¹æ“š workflow_phase åˆ†æ´¾åˆ°å°æ‡‰ handler
   â†“
6. handler è™•ç†ç”¨æˆ¶è¨Šæ¯ï¼š
   â€¢ çµæ§‹åŒ–æå–ï¼ˆLLM with_structured_output / Regexï¼‰
   â€¢ å‘¼å«å°æ‡‰ toolï¼ˆç›´æ¥ .invoke()ï¼Œé LLM æ±ºå®šï¼‰
   â€¢ æ›´æ–° state æ¬„ä½ + workflow_phase
   â†“
7. å›å‚³ AIMessageï¼ŒMemorySaver è‡ªå‹•æŒä¹…åŒ– state
   â†“
8. å›è¦†å‚³å›å‰ç«¯é¡¯ç¤º
```

### 2. è¨‚å–®å»ºç«‹æµç¨‹

```
å®¢æˆ¶: ã€Œæˆ‘è¦ä¸‹å–®ã€
  â†“ [idle â†’ collect_info]
åŠ©æ‰‹: ã€Œè«‹æä¾›åç¨±ã€åœ°å€ã€é›»è©±ã€
  â†“
å®¢æˆ¶: ã€Œç‹å¤§æ˜ï¼Œå°åŒ—101ï¼Œ0972123456ã€
  â†“ [collect_info â†’ confirm_info]  LLM structured output æå–
åŠ©æ‰‹: ã€Œè«‹ç¢ºèªï¼šåç¨±=ç‹å¤§æ˜ åœ°å€=å°åŒ—101 é›»è©±=0972123456ã€
  â†“
å®¢æˆ¶: ã€Œç¢ºèªã€
  â†“ [confirm_info â†’ collect_items]  ğŸ”§ register_customer + ğŸ”§ query_products
åŠ©æ‰‹: ã€Œå®¢æˆ¶å·²å»ºç«‹ï¼ç”¢å“åˆ—è¡¨ï¼šè˜‹æœ500å…ƒ/ç®±...  è«‹é¸è³¼ã€
  â†“
å®¢æˆ¶: ã€Œè˜‹æœ*2 ç‰›å¥¶*3ã€
  â†“ [collect_items â†’ confirm_items]  Regex è§£æ + ğŸ”§ create_order_draft
åŠ©æ‰‹: ã€Œè˜‹æœx2=1000å…ƒ ç‰›å¥¶x3=135å…ƒ ç¸½è¨ˆ1135å…ƒï¼Œç¢ºèªï¼Ÿã€
  â†“
å®¢æˆ¶: ã€Œç¢ºèªã€ï¼ˆæˆ–ã€Œå†åŠ ç™½ç±³5åŒ…ã€â†’ åˆä½µå¾Œé‡æ–°é©—è­‰ï¼‰
  â†“ [confirm_items â†’ collect_delivery]
åŠ©æ‰‹: ã€Œé…é€æ–¹å¼ï¼šå°ˆè»Š/éƒµå¯„ï¼Ÿæ”¶æ¬¾æ–¹å¼ï¼šç¾é‡‘/åŒ¯æ¬¾/è²¨åˆ°ä»˜æ¬¾ï¼Ÿã€
  â†“
å®¢æˆ¶: ã€Œéƒµå¯„ ç¾é‡‘ã€
  â†“ [collect_delivery â†’ preview_order]  LLM æå– + ğŸ”§ preview_final_order
åŠ©æ‰‹: ã€Œå®Œæ•´è¨‚å–®ï¼šè˜‹æœx2... é…é€=éƒµå¯„ æ”¶æ¬¾=ç¾é‡‘ï¼Œç¢ºèªï¼Ÿã€
  â†“
å®¢æˆ¶: ã€Œç¢ºèªã€
  â†“ [preview_order â†’ idle]  ğŸ”§ confirm_order (å¯«å…¥DB + æ‰£åº«å­˜)
åŠ©æ‰‹: ã€Œâœ… è¨‚å–®å»ºç«‹æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿ: 1ã€
```

---

## ğŸ› ï¸ å·¥å…·å‡½æ•¸ (Tools) èªªæ˜

### ä¸‹å–®æµç¨‹å·¥å…·ï¼ˆç”± StateGraph å„ç¯€é»æŒ‰é †åºå‘¼å«ï¼‰

| å·¥å…· | æ­¥é©Ÿ | åŠŸèƒ½ | æ˜¯å¦å¯«å…¥ DB |
|------|------|------|------------|
| register_customer | æ­¥é©Ÿä¸€ | å»ºç«‹/æ›´æ–°å®¢æˆ¶ï¼ˆåç¨±ã€åœ°å€ã€é›»è©±ï¼‰ | âœ… |
| create_order_draft | æ­¥é©ŸäºŒ | é©—è­‰å“é …+åº«å­˜ã€è¨ˆç®—é‡‘é¡ | âŒ åªè®€ |
| preview_final_order | æ­¥é©Ÿä¸‰ | ç”¢ç”Ÿå«é…é€/æ”¶æ¬¾çš„å®Œæ•´æ‘˜è¦ | âŒ åªè®€ |
| confirm_order | æ­¥é©Ÿä¸‰ | å¯«å…¥è¨‚å–®+æ˜ç´°ã€æ‰£é™¤åº«å­˜ | âœ… |

### ä¸€èˆ¬æŸ¥è©¢å·¥å…·ï¼ˆç”± General ReAct Agent è‡ªç”±å‘¼å«ï¼‰

| å·¥å…· | åŠŸèƒ½ | æ˜¯å¦å¯«å…¥ DB |
|------|------|------------|
| query_products | æŸ¥è©¢/æœå°‹ç”¢å“è³‡è¨Š | âŒ |
| check_stock | æª¢æŸ¥åº«å­˜ï¼ˆä½æ–¼å®‰å…¨åº«å­˜æœƒè­¦å‘Šï¼‰ | âŒ |
| query_orders | ä¾å®¢æˆ¶åç¨±æˆ–è¨‚å–® ID æŸ¥è©¢è¨‚å–® | âŒ |
| record_wastage | è¨˜éŒ„ç”¢å“æè€—ä¸¦æ‰£é™¤åº«å­˜ | âœ… |

---

## ğŸ› ï¸ æŠ€è¡“æ£§

| å±¤ç´š | æŠ€è¡“ | ç”¨é€” |
|------|------|------|
| **å‰ç«¯** | HTML5 + Vanilla JS + CSS3 | èŠå¤©ä»‹é¢ã€ç®¡ç†å¾Œå°ã€ç”¢å“åˆ—è¡¨ |
| **å¾Œç«¯æ¡†æ¶** | FastAPI | REST API æœå‹™ |
| **AI æ¡†æ¶** | LangGraph StateGraph | ç‹€æ…‹æ©Ÿé©…å‹•çš„ä¸‹å–®æµç¨‹ |
| **AI æ¡†æ¶** | LangGraph create_react_agent | ä¸€èˆ¬æŸ¥è©¢çš„ ReAct Agent |
| **LLM** | Groq API + llama-3.3-70b-versatile | å°è©±ç†è§£å’Œçµæ§‹åŒ–æå– |
| **çµæ§‹åŒ–æå–** | Pydantic + with_structured_output | å¾è‡ªç„¶èªè¨€æå–å®¢æˆ¶è³‡æ–™/å“é …/é…é€æ–¹å¼ |
| **ç‹€æ…‹ç®¡ç†** | MemorySaver (LangGraph) | Session ç‹€æ…‹æŒä¹…åŒ– |
| **è³‡æ–™åº«** | SQLite3 | å®¢æˆ¶/ç”¢å“/è¨‚å–®/æè€— |
| **è³‡æ–™é©—è­‰** | Pydantic | API è«‹æ±‚/å›æ‡‰æ¨¡å‹ |

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
0212_product/
â”œâ”€â”€ agent.py                 # StateGraph ç‹€æ…‹æ©Ÿ + General ReAct Agent
â”‚   â”œâ”€ OrderState            # ç‹€æ…‹å®šç¾© (workflow_phase, å®¢æˆ¶è³‡æ–™, å“é …ç­‰)
â”‚   â”œâ”€ handle_idle()         # åˆ†æ´¾ï¼šä¸‹å–® â†’ æµç¨‹ / å…¶ä»– â†’ ReAct Agent
â”‚   â”œâ”€ handle_collect_info() # LLM structured output æå–å®¢æˆ¶è³‡æ–™
â”‚   â”œâ”€ handle_confirm_info() # ç¢ºèª â†’ register + åˆ—å‡ºç”¢å“
â”‚   â”œâ”€ handle_collect_items()# Regex/LLM è§£æå“é … + draft é©—è­‰
â”‚   â”œâ”€ handle_confirm_items()# ç¢ºèª â†’ æ­¥é©Ÿä¸‰ / ä¿®æ”¹ â†’ åˆä½µå“é …
â”‚   â”œâ”€ handle_collect_delivery() # LLM æå–é…é€æ”¶æ¬¾ + preview
â”‚   â”œâ”€ handle_preview_order()# ç¢ºèª â†’ confirm_order / ä¿®æ”¹
â”‚   â””â”€ agent_executor        # ç·¨è­¯å¾Œçš„ StateGraph (å« MemorySaver)
â”‚
â”œâ”€â”€ tools.py                 # 8 å€‹ @tool å·¥å…·å‡½æ•¸
â”œâ”€â”€ database.py              # SQLite åˆå§‹åŒ–ã€é€£ç·šã€ç¨®å­è³‡æ–™
â”œâ”€â”€ main.py                  # FastAPI è·¯ç”± + session ç®¡ç†
â”œâ”€â”€ models.py                # Pydantic æ¨¡å‹ (ChatRequest/ChatResponse)
â”œâ”€â”€ test_chat.py             # è‡ªå‹•åŒ–å°è©±æ¸¬è©¦è…³æœ¬
â”œâ”€â”€ requirements.txt         # Python ä¾è³´
â”œâ”€â”€ .env                     # GROQ_API_KEY
â”œâ”€â”€ reset.sh                 # é‡è¨­ DB + é‡å•Ÿ server
â”‚
â””â”€â”€ static/
    â”œâ”€â”€ index.html           # å®¢æˆ¶èŠå¤©ä»‹é¢
    â”œâ”€â”€ admin.html           # ç®¡ç†å¾Œå°ï¼ˆ5 å¼µè¡¨ + è¨‚å–®æŸ¥è©¢ï¼‰
    â”œâ”€â”€ products.html        # ç”¢å“åˆ—è¡¨é é¢
    â”œâ”€â”€ app.js               # èŠå¤©å‰ç«¯é‚è¼¯
    â””â”€â”€ style.css            # æ¨£å¼è¡¨
```

---

## ğŸš€ å•Ÿå‹•æ–¹å¼

```bash
# å®‰è£ä¾è³´
pip install -r requirements.txt

# è¨­å®š .env
echo "GROQ_API_KEY=your_key" > .env

# å•Ÿå‹•ï¼ˆé–‹ç™¼æ¨¡å¼ï¼Œè‡ªå‹• reloadï¼‰
uvicorn main:app --reload --port 8000

# é‡è¨­ DB + é‡å•Ÿ
./reset.sh

# åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦ï¼ˆéœ€å…ˆå•Ÿå‹• serverï¼‰
python test_chat.py
```

### è¨ªå•ä»‹é¢

- **å®¢æˆ¶èŠå¤©**ï¼šhttp://localhost:8000/
- **ç”¢å“åˆ—è¡¨**ï¼šhttp://localhost:8000/products
- **ç®¡ç†å¾Œå°**ï¼šhttp://localhost:8000/admin
- **API æ–‡ä»¶**ï¼šhttp://localhost:8000/docs

---

## ğŸ” å®‰å…¨æ€§

1. **SQL Injection é˜²è­·**ï¼šæ‰€æœ‰ tools.py ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ (`?` placeholder)
2. **è³‡æ–™è¡¨ç™½åå–®**ï¼š`/api/admin/table/*` é™åˆ¶ 5 å¼µå…è¨±çš„è¡¨
3. **Foreign Keys**ï¼š`PRAGMA foreign_keys = ON` å¼·åˆ¶ç´„æŸ
4. **API Key**ï¼š`.env` ç®¡ç†ï¼Œå·²åŠ å…¥ `.gitignore`
5. **Tool éš”é›¢**ï¼šStateGraph å„ç¯€é»åªèƒ½å‘¼å«å°æ‡‰çš„ toolï¼Œé˜²æ­¢èª¤æ“ä½œ

---

**å»ºç«‹æ—¥æœŸ**ï¼š2026-02-12
**ç‰ˆæœ¬**ï¼š2.0ï¼ˆStateGraph æ¶æ§‹ï¼‰
**æœ€å¾Œæ›´æ–°**ï¼š2026-02-12
