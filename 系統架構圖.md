# 🏗️ AI 客服系統 - 完整架構文件

## 系統概述

這是一個基於 **AI Agent** 的智能客服系統，使用 **LangGraph 的 ReAct Pattern** 來處理客戶對話，並透過工具函數與資料庫互動，實現產品查詢、訂單管理、庫存追蹤等完整功能。

---

## 📐 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                      前端層 (Frontend)                       │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📱 客戶聊天介面              📊 管理後台                    │
│  (index.html)                (admin.html)                   │
│                                                              │
│  • 聊天訊息輸入              • 查看資料表                    │
│  • 對話歷史顯示              • 查看訂單/庫存                 │
│  • Session 管理              • 數據監控                      │
│                                                              │
│  JavaScript (app.js) + CSS (style.css)                      │
└──────────────────┬──────────────────────────────────────────┘
                   │ HTTP/REST API
                   ▼
┌─────────────────────────────────────────────────────────────┐
│                  API 層 (FastAPI Backend)                    │
│                        main.py                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  🔹 POST /api/chat                                           │
│     └─ 處理客戶對話請求                                      │
│                                                              │
│  🔹 GET /api/admin/table/{table_name}                        │
│     └─ 查詢資料表數據                                        │
│                                                              │
│  🔹 GET /                                                    │
│     └─ 首頁（客戶聊天介面）                                  │
│                                                              │
│  🔹 GET /admin                                               │
│     └─ 管理後台介面                                          │
│                                                              │
│  📦 models.py (ChatRequest, ChatResponse)                    │
└────────────┬────────────────────────────┬───────────────────┘
             │                            │
             ▼                            ▼
┌─────────────────────────────┐  ┌──────────────────────────┐
│   AI Agent 層 (LangGraph)   │  │     資料庫管理層         │
│        agent.py             │  │      database.py         │
├─────────────────────────────┤  ├──────────────────────────┤
│                             │  │                          │
│  🤖 Agent Executor          │  │  • init_db()            │
│     (ReAct Pattern)         │  │  • seed_sample_data()   │
│                             │  │  • get_connection()     │
│  🧠 LLM: ChatGroq           │  │                          │
│     llama-3.3-70b-versatile │  │  📊 SQLite DB           │
│                             │  │     (product.db)        │
│  📝 System Prompt           │  │                          │
│     (客服流程指引)           │  └──────────────────────────┘
│                             │              │
│  🛠️ 6 個工具函數:           │              │
│     tools.py                │◄─────────────┘
└─────────────────────────────┘
             │
             ├─ 🔧 query_products      (查詢產品)
             ├─ 🔧 check_stock         (檢查庫存)
             ├─ 🔧 create_order        (建立訂單)
             ├─ 🔧 query_orders        (查詢訂單)
             ├─ 🔧 record_wastage      (記錄損耗)
             └─ 🔧 manage_customer     (管理客戶)
                        │
                        ▼
         ┌──────────────────────────────┐
         │   外部 API 服務               │
         ├──────────────────────────────┤
         │  🌐 Groq API                 │
         │     (LLM 推理服務)            │
         └──────────────────────────────┘
```

---

## 📊 資料庫架構 (SQLite)

```
product.db
├─ 👤 customer               (客戶資料表)
│  ├─ customer_id (PK)
│  ├─ customer_name
│  ├─ customer_address
│  └─ customer_phone
│
├─ 📦 product                (產品資料表)
│  ├─ product_id (PK)
│  ├─ product_name
│  ├─ unit
│  ├─ price
│  ├─ stock
│  ├─ safety_stock
│  ├─ supplier
│  └─ specification
│
├─ 🛒 orders                 (訂單主表)
│  ├─ order_id (PK)
│  ├─ customer_name
│  ├─ delivery_method
│  ├─ payment_method
│  └─ order_amount
│
├─ 📋 customer_order_detail  (訂單明細表)
│  ├─ id (PK)
│  ├─ customer_id (FK)
│  ├─ product_id (FK)
│  ├─ order_id (FK)
│  └─ quantity
│
└─ ⚠️ wastage                (損耗記錄表)
   ├─ id (PK)
   ├─ product_name
   ├─ product_id (FK)
   └─ loss_quantity
```

### 資料表關係說明

- `customer` ↔ `customer_order_detail`：一對多關係
- `product` ↔ `customer_order_detail`：一對多關係
- `orders` ↔ `customer_order_detail`：一對多關係
- `product` ↔ `wastage`：一對多關係

---

## 🔄 核心數據流程

### 1. 客戶對話流程

```
1. 客戶在前端輸入訊息
   ↓
2. POST /api/chat 發送請求 (包含 message 和 session_id)
   ↓
3. main.py 接收請求，從 chat_histories 取得對話歷史
   ↓
4. Agent Executor 接收訊息列表
   ↓
5. LLM (Groq llama-3.3-70b) 根據 System Prompt 分析意圖
   ↓
6. 決定是否需要調用工具函數 (tools.py)
   ↓
7. 工具函數執行資料庫操作 (database.py)
   ↓
8. 將執行結果返回給 Agent
   ↓
9. LLM 根據工具執行結果生成自然語言回覆
   ↓
10. 回覆傳回前端顯示，並更新 chat_histories
```

### 2. 訂單建立流程

```
客戶說「我要下單」
   ↓
Agent: 詢問客戶基本資料（名稱、地址、電話）
   ↓
客戶: 提供資料
   ↓
Agent: 解析並確認資料
   ↓
客戶: 確認
   ↓
Tool: manage_customer() - 建立或更新客戶資料
   ↓
Tool: query_products() - 列出所有產品
   ↓
Agent: 請客戶選擇產品和數量
   ↓
客戶: 選擇產品
   ↓
Agent: 詢問配送方式和付款方式
   ↓
客戶: 提供配送和付款資訊
   ↓
Agent: 確認訂單詳情
   ↓
客戶: 確認
   ↓
Tool: create_order() - 建立訂單並扣除庫存
   ↓
完成！返回訂單編號和金額
```

---

## 🛠️ 技術棧詳細說明

| 層級 | 技術 | 用途 | 版本 |
|------|------|------|------|
| **前端** | HTML5 | 頁面結構 | - |
| **前端** | JavaScript (Vanilla) | 互動邏輯 | ES6+ |
| **前端** | CSS3 | 樣式設計 | - |
| **後端框架** | FastAPI | RESTful API 服務 | 最新 |
| **AI 框架** | LangChain | LLM 應用開發框架 | 最新 |
| **AI 框架** | LangGraph | Agent 工作流編排 | 最新 |
| **LLM 提供商** | Groq | 高速推理服務 | API |
| **LLM 模型** | llama-3.3-70b-versatile | 對話和推理 | 3.3 |
| **資料庫** | SQLite3 | 輕量級關聯式資料庫 | 3.x |
| **資料驗證** | Pydantic | 資料模型驗證 | 2.x |
| **環境管理** | python-dotenv | 環境變數管理 | 最新 |

---

## 📁 完整檔案結構

```
0212_product/
├── agent.py                 # AI Agent 配置
│   ├─ SYSTEM_PROMPT        # 客服流程指引 Prompt
│   ├─ build_agent()        # 建立 Agent 實例
│   └─ agent_executor       # Agent 執行器
│
├── database.py             # 資料庫初始化與連接
│   ├─ get_connection()     # 建立資料庫連接
│   ├─ init_db()            # 初始化資料表結構
│   └─ seed_sample_data()   # 填充範例資料
│
├── main.py                 # FastAPI 主程式
│   ├─ /api/chat            # 聊天 API
│   ├─ /api/admin/table/*   # 管理後台 API
│   ├─ /                    # 首頁
│   └─ /admin               # 管理後台
│
├── models.py               # Pydantic 模型定義
│   ├─ ChatRequest          # 聊天請求模型
│   └─ ChatResponse         # 聊天回應模型
│
├── tools.py                # 6 個工具函數
│   ├─ query_products()     # 查詢產品
│   ├─ check_stock()        # 檢查庫存
│   ├─ create_order()       # 建立訂單
│   ├─ query_orders()       # 查詢訂單
│   ├─ record_wastage()     # 記錄損耗
│   └─ manage_customer()    # 管理客戶
│
├── requirements.txt        # Python 依賴套件
├── product.db             # SQLite 資料庫檔案
├── .env                   # 環境變數（GROQ_API_KEY）
│
└── static/                # 靜態前端檔案
    ├── index.html         # 客戶聊天介面
    ├── admin.html         # 管理後台介面
    ├── app.js             # JavaScript 邏輯
    └── style.css          # 樣式表
```

---

## 🔧 工具函數 (Tools) 詳細說明

### 1. query_products(product_name: str = "")
**功能**：查詢產品資訊
- **輸入**：產品名稱（選填）
- **輸出**：產品清單（包含 ID、名稱、價格、庫存、供應商、規格）
- **用途**：列出所有產品或搜尋特定產品

### 2. check_stock(product_name: str)
**功能**：檢查庫存狀況
- **輸入**：產品名稱（必填）
- **輸出**：庫存狀態（目前庫存、安全庫存、警告狀態）
- **用途**：監控庫存並在低於安全庫存時發出警告

### 3. create_order(customer_name, items, delivery_method, payment_method)
**功能**：建立新訂單
- **輸入**：
  - customer_name: 客戶名稱
  - items: 產品列表 `[{product_id: int, quantity: int}]`
  - delivery_method: 配送方式（專車/郵寄）
  - payment_method: 付款方式
- **輸出**：訂單編號、訂單金額
- **用途**：建立訂單並自動扣除庫存

### 4. query_orders(customer_name: str = "", order_id: int = 0)
**功能**：查詢訂單
- **輸入**：客戶名稱或訂單編號（擇一）
- **輸出**：訂單資訊和明細
- **用途**：查詢歷史訂單

### 5. record_wastage(product_name: str, loss_quantity: int)
**功能**：記錄產品損耗
- **輸入**：產品名稱、損耗數量
- **輸出**：損耗記錄和剩餘庫存
- **用途**：記錄損耗並自動扣除庫存

### 6. manage_customer(customer_name, customer_address, customer_phone)
**功能**：管理客戶資料
- **輸入**：客戶名稱、地址、電話
- **輸出**：客戶 ID 和確認訊息
- **用途**：新增或更新客戶資料（存在則更新，不存在則新增）

---

## 🎯 AI Agent 工作原理

### ReAct Pattern (Reasoning + Acting)

Agent 使用 **ReAct 模式**，結合推理和行動：

1. **Thought**（思考）：分析用戶意圖
2. **Action**（行動）：決定調用哪個工具
3. **Observation**（觀察）：接收工具執行結果
4. **Repeat**（重複）：根據需要重複上述步驟
5. **Answer**（回答）：生成最終回覆

### System Prompt 設計

System Prompt 定義了完整的訂單流程：

**步驟一：建立客戶資料**
- 詢問客戶資料（名稱、地址、電話）
- 確認資料
- 使用 `manage_customer` 工具存入資料庫

**步驟二：選擇產品**
- 使用 `query_products` 列出產品
- 客戶選擇產品和數量

**步驟三：選擇配送與付款**
- 詢問配送方式（專車/郵寄）
- 詢問收款方式

**步驟四：確認訂單**
- 整理完整訂單資訊
- 客戶確認後使用 `create_order` 建立訂單

---

## 🚀 啟動流程

### 1. 環境設定

```bash
# 安裝依賴
pip install -r requirements.txt

# 設定環境變數
echo "GROQ_API_KEY=your_api_key_here" > .env
```

### 2. 啟動服務

```bash
# 啟動 FastAPI 服務
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 訪問介面

- **客戶聊天介面**：http://localhost:8000/
- **管理後台**：http://localhost:8000/admin
- **API 文件**：http://localhost:8000/docs

---

## 📝 API 端點說明

### POST /api/chat
處理客戶對話請求

**Request Body:**
```json
{
  "message": "我想查詢產品",
  "session_id": "user_123"
}
```

**Response:**
```json
{
  "reply": "以下是我們的產品清單：\n產品ID: 1, 名稱: 蘋果..."
}
```

### GET /api/admin/table/{table_name}
查詢資料表數據

**允許的資料表：**
- customer
- product
- orders
- customer_order_detail
- wastage

**Response:**
```json
{
  "columns": ["product_id", "product_name", "price", ...],
  "rows": [
    {"product_id": 1, "product_name": "蘋果", ...},
    ...
  ]
}
```

---

## 🔐 安全性考量

1. **SQL Injection 防護**：使用參數化查詢
2. **資料表白名單**：限制可訪問的資料表
3. **Foreign Keys**：啟用外鍵約束保持資料完整性
4. **API Key 保護**：使用 .env 管理敏感資訊

---

## 📈 擴展建議

### 短期優化
1. 添加使用者認證系統
2. 實作訂單狀態追蹤（待處理、已出貨、已完成）
3. 增加產品分類和搜尋功能
4. 添加庫存自動補貨提醒

### 長期規劃
1. 遷移到 PostgreSQL 或 MySQL
2. 實作快取機制（Redis）
3. 添加日誌和監控系統
4. 支援多語言對話
5. 整合第三方支付系統

---

## 📞 系統特色

✅ **智能對話**：使用 LLM 理解自然語言  
✅ **工具調用**：自動選擇合適的工具函數  
✅ **流程引導**：按步驟引導客戶完成訂單  
✅ **庫存管理**：自動扣除庫存並警告低庫存  
✅ **資料持久化**：SQLite 儲存所有交易記錄  
✅ **管理後台**：實時查看資料表數據  
✅ **會話管理**：支援多用戶同時對話  

---

**建立日期**：2026-02-12  
**版本**：1.0  
**最後更新**：2026-02-12
